"use client";

import React, { useState, useRef, useEffect } from "react";
import styles from "@/app/styles/components/stock/StockOrder.module.css";
import MyOrder from "../user/MyOrder";
import TabMenu from "../utills/TabMenu";
import RemoveIcon  from "@mui/icons-material/Remove";
import AddIcon from "@mui/icons-material/Add";
import { OrderbookData } from "@/lib/api/stock"
import { Client } from "@stomp/stompjs";
import { useAuth } from "@/context/AuthContext";

interface StockOrderProps {
  stockName: string;
  ticker: string; 
  currentPrice: number;
}

const StockOrder = ({ stockName, currentPrice, ticker }: StockOrderProps) => {
  const myMoney = 1000000;
  
  const [activeTab, setActiveTab] = useState<string>("Ï≤¥Í≤∞ ÎÇ¥Ïó≠");
  const tabList = ["Ï≤¥Í≤∞ ÎÇ¥Ïó≠", "ÎØ∏Ï≤¥Í≤∞ ÎÇ¥Ïó≠"];
  const [useCurrentPrice, setUseCurrentPrice] = useState(false);
  const [orderType, setOrderType] = useState<"buy" | "sell">("buy");
  const [quantity, setQuantity] = useState(0);
  const [price, setPrice] = useState(currentPrice);
  const [priceInput, setPriceInput] = useState(currentPrice.toString());

  const scrollRef = useRef<HTMLDivElement>(null);
  const totalPrice = quantity * price;

  const [orderbook, setOrderbook] = useState<OrderbookData | null>(null);
  const { accessToken } = useAuth();

  useEffect(() => {
    if (!ticker) return;

    const client = new Client({
      webSocketFactory: () => new WebSocket(process.env.NEXT_PUBLIC_SOCKET_URL!),
      connectHeaders: {
        Authorization: `Bearer ${accessToken}`, 
      },
      reconnectDelay: 15_000,
      heartbeatIncoming: 10_000,
      heartbeatOutgoing: 10_000,

      onConnect: () => {
        client.subscribe(`/topic/orderbook/${ticker}`, (message) => {
          try {
            const data = JSON.parse(message.body) as OrderbookData;
            console.log("‚úÖ Ïã§ÏãúÍ∞Ñ Ìò∏Í∞Ä Îç∞Ïù¥ÌÑ∞:", data); // üîç ÌôïÏù∏ Ìè¨Ïù∏Ìä∏
            setOrderbook(data);
          } catch (err) {
            console.error("Ìò∏Í∞Ä Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨ Ïò§Î•ò:", err);
          }
        });
      },

      onStompError: (frame) => {
        console.error("WebSocket STOMP Ïò§Î•ò:", frame.headers["message"]);
      },
    });

    client.activate();

    return () => {
      client.deactivate();
    };
  }, [ticker]);

  useEffect(() => {
    const el = scrollRef.current;
    if (!el) return;
    if (!accessToken) {
      console.warn("‚ö†Ô∏è accessToken ÏóÜÏùå - WebSocket Ïó∞Í≤∞ Í±¥ÎÑàÎúÄ");
      return;
    }

    const allHogas = el.querySelectorAll("[data-price]");
    const currentPriceElement = Array.from(allHogas).find((div) => {
      return Number(div.getAttribute("data-price")) === currentPrice;
    });

    if (currentPriceElement) {
      currentPriceElement.scrollIntoView({
        behavior: "smooth",
        block: "center",
      });
    }
  }, [stockName, currentPrice]);

  useEffect(() => {
    if (useCurrentPrice) {
      setPrice(currentPrice);
      setPriceInput(currentPrice.toString());
    }
  }, [useCurrentPrice, currentPrice]);

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    const orderData = {
      type: orderType,
      stock: stockName,
      quantity,
      price,
      totalPrice
    };
    console.log("Ï£ºÎ¨∏ Îç∞Ïù¥ÌÑ∞:", orderData);
    // ÏÑúÎ≤Ñ Ï†ÑÏÜ° Ï≤òÎ¶¨ Í∞ÄÎä•
  };

  const handleQuantityRatioChange = (e: React.ChangeEvent<HTMLSelectElement>) => {
    const ratio = Number(e.target.value);
    if (price > 0) {
      const qty = Math.floor((myMoney * ratio) / price);
      setQuantity(qty);
    }
  };

  const handlePriceClick = (clickedPrice: number) => {
    setPrice(clickedPrice);
    setPriceInput(clickedPrice.toString());
    setUseCurrentPrice(false);
  };

  const handlePriceInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    let raw = e.target.value.replace(/,/g, "");
    if (!/^\d*$/.test(raw)) return; // Ïà´Ïûê Ïô∏ ÏûÖÎ†• Ï∞®Îã®

    setPriceInput(raw);

    const number = parseInt(raw, 10);
    if (!isNaN(number)) {
      const adjusted = Math.floor(number / 10) * 10;
      setPrice(adjusted);
      setUseCurrentPrice(false);
    }
  };

  const handlePriceBlur = () => {
    setPriceInput(price.toLocaleString());
  };

  const bidOrders = orderbook?.bidPrices.map((price, i) => ({
    price,
    quantity: orderbook.bidVolumes[i],
  })) ?? [];

  const askOrders = orderbook?.askPrices.map((price, i) => ({
    price,
    quantity: orderbook.askVolumes[i],
  })) ?? [];

  // ÏµúÎåÄÍ∞í (ÌçºÏÑºÌä∏ Í∏∞Ï§ÄÏö©)
  const maxBidQty = Math.max(...bidOrders.map(o => o.quantity), 1);
  const maxAskQty = Math.max(...askOrders.map(o => o.quantity), 1);
  const currentQty =
    bidOrders.find((o) => o.price === currentPrice)?.quantity ??
    askOrders.find((o) => o.price === currentPrice)?.quantity ?? 0;

  return (
    <div className={styles.orderContainer}>
      <h1 className={styles.title}>{stockName} Ï£ºÏãùÏ£ºÎ¨∏</h1>

      <div className={styles.myMoney}>
        <h1>Î≥¥Ïú†ÏûêÏÇ∞</h1>
        <h1><span>{myMoney.toLocaleString()}</span>Ïõê</h1>
      </div>

      <div className={styles.orderContents}>
        {/* ÏôºÏ™Ω: Ìò∏Í∞ÄÏ∞Ω */}
        <div className={styles.quoteBox}>
          <div className={styles.scrollArea} ref={scrollRef}>
            {/* Îß§ÎèÑ Ìò∏Í∞Ä (ask) - ÏúÑÏ™Ω */}
            {askOrders.map((order, i) => {
              const percent = (order.quantity / maxAskQty) * 100;
              return (
                <div
                  key={`ask-${i}`}
                  data-price={order.price}
                  className={styles.ask}
                  onClick={() => handlePriceClick(order.price)}
                >
                  <div
                    className={styles.hogaOverlayBar}
                    style={{ width: `${percent}%`, backgroundColor: "#93B9E1" }}
                  />
                  <div className={styles.hogaOverlayRow}>
                    <span className={styles.hogaPrice}>{order.price.toLocaleString()}</span>
                    <span className={styles.hogaQty}>{order.quantity.toLocaleString()}</span>
                  </div>
                </div>
              );
            })}

            {/* ÌòÑÏû¨Í∞Ä */}
            <div
              data-price={currentPrice}
              className={styles.centerLine}
              onClick={() => handlePriceClick(currentPrice)}
            >
              <div className={styles.hogaOverlayRow}>
                <span className={styles.hogaOverlayText}>{currentPrice.toLocaleString()}</span>
                <span className={styles.hogaQty}>{currentQty.toLocaleString()}</span>
              </div>
            </div>

            {/* Îß§Ïàò Ìò∏Í∞Ä (bid) - ÏïÑÎûòÏ™Ω */}
            {bidOrders.map((order, i) => {
              const percent = (order.quantity / maxBidQty) * 100;
              return (
                <div
                  key={`bid-${i}`}
                  data-price={order.price}
                  className={styles.bid}
                  onClick={() => handlePriceClick(order.price)}
                >
                  <div
                    className={styles.hogaOverlayBar}
                    style={{ width: `${percent}%`, backgroundColor: "#F19999" }}
                  />
                  <div className={styles.hogaOverlayRow}>
                    <span className={styles.hogaPrice}>{order.price.toLocaleString()}</span>
                    <span className={styles.hogaQty}>{order.quantity.toLocaleString()}</span>
                  </div>
                </div>
              );
            })}
          </div>
        </div>

        {/* Ïò§Î•∏Ï™Ω: Ï£ºÎ¨∏ Ìèº */}
        <form className={styles.orderForm} onSubmit={handleSubmit}>
          {/* Îß§Ïàò/Îß§ÎèÑ ÌÉ≠ */}
          <div className={styles.row}>
            <div className={styles.tabGroup}>
              <button
                type="button"
                className={`${styles.tab} ${orderType === "buy" ? styles.activeBid : ""}`}
                onClick={() => setOrderType("buy")}
              >
                Îß§Ïàò
              </button>
              <button
                type="button"
                className={`${styles.tab} ${orderType === "sell" ? styles.activeAsk : ""}`}
                onClick={() => setOrderType("sell")}
              >
                Îß§ÎèÑ
              </button>
            </div>
          </div>

          {/* ÏàòÎüâ */}
          <div className={styles.row}>
            <label>ÏàòÎüâ</label>
            <div className={styles.rowContainer}>
              <input
                type="text"
                value={quantity}
                onChange={(e) => {
                  const raw = e.target.value.replace(/[^0-9]/g, "");
                  setQuantity(Number(raw));
                }}
              />
              <select onChange={handleQuantityRatioChange} defaultValue="">
                <option value="" disabled>ÎπÑÏú®</option>
                <option value="0.1">10%</option>
                <option value="0.25">25%</option>
                <option value="0.5">50%</option>
                <option value="0.75">75%</option>
                <option value="1">100%</option>
              </select>
            </div>
          </div>

          {/* Í∞ÄÍ≤© */}
          <div className={styles.row}>
            <label>Í∞ÄÍ≤©</label>
            <div className={styles.rowContainer}>
              <input
                type="text"
                value={priceInput}
                onChange={handlePriceInputChange}
                onBlur={handlePriceBlur}
              />
              <button
                type="button"
                className={styles.priceBtn}
                onClick={() => {
                  setUseCurrentPrice(false);
                  const newPrice = Math.max(price - 10, 0);
                  setPrice(newPrice);
                  setPriceInput(newPrice.toString());
                }}
              ><RemoveIcon/></button>
              <button
                type="button"
                className={styles.priceBtn}
                onClick={() => {
                  setUseCurrentPrice(false);
                  const newPrice = price + 10;
                  setPrice(newPrice);
                  setPriceInput(newPrice.toString());
                }}
              ><AddIcon/></button>
            </div>
            <div className={styles.checkboxWrapper}>
              <input
                type="checkbox"
                id="useCurrentPrice"
                checked={useCurrentPrice}
                onChange={(e) => setUseCurrentPrice(e.target.checked)}
              />
              <label htmlFor="useCurrentPrice">ÏûêÎèô(ÌòÑÏû¨Í∞Ä)</label>
            </div>
          </div>

          {/* Ï£ºÎ¨∏Ï¥ùÏï° Î∞è Î≤ÑÌäº */}
          <div className={styles.total}>
            <label>Ï£ºÎ¨∏Ï¥ùÏï°</label>
            <div className={styles.totalContainer}>
              <input type="text" value={totalPrice.toLocaleString()} readOnly />
              <span>Ïõê</span>
            </div>
          </div>

          <button
            type="submit"
            className={`${styles.submit} ${orderType === "buy" ? styles.bidColor : styles.askColor}`}
          >
            {orderType === "buy" ? "Îß§Ïàò" : "Îß§ÎèÑ"}
          </button>
        </form>
      </div>
      
      <TabMenu
        tabs={tabList}
        activeTab={activeTab}
        onTabChange={(tab) => setActiveTab(tab)}
        tabTextSize="1rem"
      />
      <div className={styles.myOrderWrapper}>
        <MyOrder activeTab={activeTab} />
      </div>
    </div>
  );
};

export default StockOrder;